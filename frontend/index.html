<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello</title>
    <link href="input.css" rel="stylesheet">
    <link href="/dist/output.css" rel="stylesheet">
    <script src="script.js"></script>
    <script>
        let id_editing = ""
        let state = ""
        let logged_in = false

        let filtered = []

        function closePopup() {
            document.getElementById("popup").style.display = "none";
            id_editing = ""
            state = ""
        }

        function showPopup2(mode, id = "") { //mode will be implement by other function
            const popup = document.getElementById("popup");
            if (mode === "create") {
                state = "create"
                document.getElementById("btn_delete").style.display = "none"
                document.getElementById("dialog_title").innerText = "Create Task"
                document.getElementById("txt_task").value = "";
                document.getElementById("txt_desc").value = "";
                document.getElementById("date_picker").value = "";
            } else if (mode === "edit") {
                id_editing = id
                state = "edit"
                const task = data.find((e) => e.item_id === id_editing)
                document.getElementById("btn_delete").style.display = "block"
                document.getElementById("dialog_title").innerText = "Edit Task"
                document.getElementById("txt_task").value = task.title;
                document.getElementById("txt_desc").value = task.desc;
                document.getElementById("date_picker").value = task.date.split('/').join('-');
            }
            popup.style.display = "block";
        }

        async function saveChanges() {
            const title = document.getElementById("txt_task").value;
            const desc = document.getElementById("txt_desc").value;
            const date = document.getElementById("date_picker").value.split('-').join('/');

            if (state === "edit") {
                console.log("EDITING")
                await updateItem(id_editing, title, desc, date);
            } else if (state === "create") {
                await createItem(title, desc, date);
            }
        }

        const submitHandler = async () => {
            await saveChanges()
            await updateData();
            await searchHandler();
            await updateUI();
            closePopup();

        }

        const deleteHandler = async () => {
            await removeItem(id_editing);
            await updateData();
            await searchHandler();
            await updateUI();
            closePopup();
        }



        let data1 = [];
        let data2 = [];
        let data = []

        const editDialog = (item_id) => {
            id_editing = item_id
            document.getElementById("dialog_title").innerText = "Edit Task"
            for (const e of data1) {
                if (e.item_id === item_id) {
                    document.getElementById("date_picker").value = e.date.split('/').join('-')
                    document.getElementById("txt_task").value = e.title
                    document.getElementById("txt_desc").value = e.desc
                    break;
                }
            }
            showPopup()
        }

        const searchHandler = () => {
            const searchValue = document.getElementById("searchbox").value.trim().toLowerCase();
            updateFilter(searchValue);
            updateUI();
        }

        const updateData = async (mcv = false) => {
            data1 = await fetchDatabase()
            if (mcv)
                data2 = await fetchMCVTasks()
            data = data1.concat(data2)
        }

        const updateFilter = (searchTerm) => {
            if (searchTerm === "") {
                filtered = data;
            } else {
                console.log("update filter hit")
                filtered = data.filter((item) => {
                    return (
                        item.title.toLowerCase().includes(searchTerm) ||
                        item.desc.toLowerCase().includes(searchTerm) ||
                        item.date.toLowerCase().includes(searchTerm)
                    );
                });
            }
        }

        // updateData updateFilter

        const updateUI = async (mcv = false) => {
            const innerHTML = filtered.sort((a, b) =>
                b.date.localeCompare(a.date)
            ).map((e) => {
                let tmp = `<div class="box" ${e.item_id !== undefined ? `onclick="showPopup2('edit','${e.item_id}')" style="cursor:pointer;"` : ""}>`;
                tmp += `<h1>${e["title"]}</h1>`;
                tmp += `<p>${e["desc"]}</p>`;
                tmp += `<p>${e["date"]}</p>`;
                tmp += `</div>`;
                return tmp;
            }).join('')
            console.log(innerHTML)
            document.getElementById("cardList").innerHTML = innerHTML;
        }
        const init = async () => {
            await fetchUsername();
            if (logged_in) {
                const logbtn = document.getElementById("btn_login")
                logbtn.innerText = "Logout"
                logbtn.onclick = () => {
                    logout()
                }
            } else {
                document.getElementById("searchbox").style.display = 'none'
                document.getElementById("btn_green").style.display = 'none'
                document.getElementById("main_title").innerText = "Please Login with your MCV account first."
            }
            document.getElementById("loading_text").style.display = 'block'
            document.getElementById("btn_green").style.display = 'none'
            await updateData(true)
            document.getElementById("loading_text").style.display = 'none'
            document.getElementById("btn_green").style.display = 'block'
            await updateFilter("")
            await updateUI()
        }
    </script>
</head>

<body onload="init();">
    <div class="flex items-center justify-center w-screen">
        <div class="p-8 w-full md:w-5/6 h-full bg-slate-300">
            <div class="flex flex-col items-center justify-center">
                <div class="flex md:max-w-5xl flex-col w-full space-y-4">
                    <div class="flex w-full justify-between flex-col md:flex-row space-y-4">
                        <p class="bold">MCV TODO-LIST</p>
                        <div class="flex justify-end max_w">
                            <input class="search_box" placeholder="Search" id="searchbox" onchange="searchHandler()">
                            <button style="border-radius: 0.375rem; background-color: beige;" onclick="login();"
                                id="btn_login">Login</button>
                        </div>
                    </div>
                    <div class="task_box">
                        <div class="flex flex-col space-y-4">
                            <h1 id="main_title">Tasks List</h1>
                            <h1 id="loading_text" style="display: none;">Fetching data... Please wait.</h1>
                            <div class="flex flex-col w-full space-y-4" id="cardList">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <button class="rounded-full bg-gray-100 p-2" ">Show Popup</button> -->

            </div>
        </div>
        <div class="bottom-12 right-12 fixed">
            <button class="flex items-center justify-center rounded-full p-2 h-12 w-12 bg-green-400 text-3xl"
                onclick="showPopup2('create')" id="btn_green">
                <p class="text-center align-middle">+</p>
            </button>
        </div>
        <div class="inset-x-4 md:inset-x-40 inset-y-20 absolute" id="popup" style="display: none;">
            <div class="flex items-center justify-center w-full">

                <div class="flex flex-col space-y-2 bg-gray-100 w-full shadow-md p-8 rounded-md max-w-4xl ">

                    <div class="flex justify-between mb-4">
                        <p class="text-xl" id="dialog_title">Create Tasks</p>
                        <button class="rounded-full bg-gray-500 w-8 h-8" onclick="closePopup()">
                            <p class="text-white">X</p>
                        </button>
                    </div>

                    <!-- <input placeholder=""> -->

                    <input
                        class="rounded-md p-1.5 border-black text-gray-900 shadow-sm placeholder:text-gray-400 sm:text-sm sm:leading-6"
                        placeholder="Task Name" id="txt_task">
                    <!-- <input
                    class="block w-full rounded-md  p-1.5 border-black text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
                    placeholder="Description"> -->
                    <textarea id="txt_desc" rows="12" placeholder="Description"
                        class="rounded-md p-1.5 border-black text-gray-900 shadow-sm placeholder:text-gray-400 sm:text-sm sm:leading-6"></textarea>
                    <input id="date_picker"
                        class="rounded-md p-1.5 border-black text-gray-900 shadow-sm placeholder:text-gray-400 sm:text-sm sm:leading-6"
                        type="date">
                    <div class="flex justify-end">
                        <button class="rounded-md border-gray-400 px-4 py-2 bg-white" onclick="deleteHandler()"
                            id="btn_delete">Delete</button>
                        <button class="rounded-md border-gray-400 px-4 py-2 bg-white" onclick="submitHandler()"
                            id="btn_submit">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>