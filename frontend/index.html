<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<script>
    const backendIPAddress = "localhost:3000"
    let username = ""

    const login = () => {
        window.location.href = `http://${backendIPAddress}/courseville/auth_app`;
    }

    const logout = () => {
        window.location.href = `http://${backendIPAddress}/courseville/logout`;
    }

    const fetchUsername = async () => {
        const options = {
            method: "GET",
            credentials: "include",
        };
        await fetch(`http://${backendIPAddress}/courseville/get_profile_info`, options)
            .then((response) => {
                if (response.ok)
                    return response.json()
                else
                    throw new Error("not logged in")
            })
            .then((data) => {
                console.log(data)
                username = data["data"]["student"]["id"]
            })
            .catch((error) => console.log(error));
    }

    /*
    const options = {
            method: "GET",
            credentials: "include",
        };
    await fetch(`http://${backendIPAddress}/courseville/get_profile_info`, options)
                .then((response) => response.json())
                .then((data) => {
                    console.log(data)
                })
                .catch((error) => console.log(error));
    */

    const fetchAssignmentDetail = async (itemId) => {
        const options = {
            method: "GET",
            credentials: "include",
        };
        let detail = {}
        await fetch(`http://${backendIPAddress}/courseville/get_assignment_detail/${itemId}`, options)
            .then((response) => response.json())
            .then((data) => {
                detail = data
            })
            .catch((error) => console.log(error));
        return detail
    }

    const fetchClassTasks = async (classId) => {
        const options = {
            method: "GET",
            credentials: "include",
        };
        let tasks = []
        await fetch(`http://${backendIPAddress}/courseville/get_course_assignments/${classId}`, options)
            .then((response) => response.json())
            .then((data) => {
                data["data"].map(x => x["itemid"]).forEach(async x => {
                    const task = await fetchAssignmentDetail(x)
                    tasks.push({ "date": task["data"]["duedate"], "title": task["data"]["title"], "desc": "" })
                })
            })
            .catch((error) => console.log(error))
        return tasks
    }

    const fetchClassName = async (classId) => {
        const options = {
            method: "GET",
            credentials: "include",
        };
        let className = ""
        await fetch(`http://${backendIPAddress}/courseville/get_course_info/${classId}`, options)
            .then((response) => response.json())
            .then((data) => {
                className = data["data"]["title"]
            })
            .catch((error) => console.log(error));
        return className
    }

    const fetchMCVTasks = async () => {
        const options = {
            method: "GET",
            credentials: "include",
        };
        let l = []
        await fetch(`http://${backendIPAddress}/courseville/get_courses`, options)
            .then((response) => response.json())
            .then((data) => {
                let classes = data["data"]["student"]
                // console.log(classes)
                const latest = classes.at(-1)
                const curSemester = latest["semester"]
                const curYear = latest["year"]
                classes.filter(x => x["semester"] == curSemester && x["year"] == curYear).map(x => x["cv_cid"]).map(async x => {
                    let tasks = await fetchClassTasks(x)
                    let className = await fetchClassName(x)
                    tasks.forEach(x => x["desc"] = className)
                    l = l.concat(tasks)
                })
            })
            .catch((error) => console.log(error));
        return l
    }

    const doStuff = async () => {
        let l = await fetchMCVTasks()
        // let l = await fetchClassName("32205")
        // l.sort((a, b) => a["date"] - b["date"])
        console.log(l)
    }
</script>

<body>
    <button onclick="login()" id="btnLogin">Login</button>
    <button onclick="logout()" id="btnLogout">Logout</button>
    <button onclick="doStuff()">Test</button>

</body>

</html>